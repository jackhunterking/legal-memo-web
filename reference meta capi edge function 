/**
 * Meta Conversions API (CAPI) Edge Function
 * 
 * Handles server-side event tracking for:
 * - CompleteRegistration (from database trigger)
 * - StartTrial (from polar-webhook)
 * - Purchase (from polar-webhook)
 * 
 * Features:
 * - SHA-256 hashing of PII (email, external_id)
 * - Generates fbp if not provided
 * - Logs all events to meta_events table
 * - Supports test mode via META_TEST_EVENT_CODE
 */

import { createClient } from "npm:@supabase/supabase-js@2.46.1";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

interface MetaEventRequest {
  eventName: 'CompleteRegistration' | 'StartTrial' | 'Purchase';
  eventId: string;
  eventTime: number;
  eventSourceUrl: string;
  userData?: {
    email?: string;
    hashedEmail?: string;
    phone?: string;
    hashedPhone?: string;
    externalId?: string;
    firstName?: string;
    lastName?: string;
    fbp?: string;
    fbc?: string;
  };
  customData?: Record<string, any>;
  internalCall?: boolean;
}

interface MetaCAPIPayload {
  data: Array<{
    event_name: string;
    event_time: number;
    event_id: string;
    event_source_url: string;
    action_source: string;
    user_data: {
      em?: string[];
      ph?: string[];
      fn?: string[];
      ln?: string[];
      external_id?: string[];
      client_ip_address?: string;
      client_user_agent?: string;
      fbp?: string;
      fbc?: string;
    };
    custom_data?: Record<string, any>;
  }>;
  test_event_code?: string;
}

/**
 * SHA-256 hash helper
 */
async function sha256Hex(value: string): Promise<string> {
  const encoder = new TextEncoder();
  const data = encoder.encode(value);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hash))
    .map((b) => b.toString(16).padStart(2, "0"))
    .join("");
}

/**
 * Normalize email for hashing
 */
function normalizeEmail(email: string | undefined | null): string {
  if (!email) return "";
  return email.trim().toLowerCase();
}

/**
 * Normalize phone for hashing
 */
function normalizePhone(phone: string | undefined | null): string {
  if (!phone) return "";
  let cleaned = phone.trim();
  if (!cleaned) return "";
  cleaned = cleaned.replace(/[^\d+]/g, "");
  if (cleaned.startsWith("+")) {
    return "+" + cleaned.slice(1).replace(/\D/g, "");
  }
  return cleaned.replace(/\D/g, "");
}

/**
 * Generate fbp (Facebook browser ID) if not provided
 */
function generateFbp(eventTime: number): string {
  const random = Math.floor(Math.random() * 1e10);
  return `fb.1.${eventTime * 1000}.${random}`;
}

/**
 * Bad request response helper
 */
function badRequest(message: string) {
  return new Response(JSON.stringify({ success: false, error: message }), {
    headers: { ...corsHeaders, "Content-Type": "application/json" },
    status: 400,
  });
}

Deno.serve(async (req) => {
  // Handle CORS preflight
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    // Environment variables
    const META_PIXEL_ID = Deno.env.get("META_PIXEL_ID");
    const META_ACCESS_TOKEN = Deno.env.get("META_ACCESS_TOKEN");
    const META_TEST_EVENT_CODE = Deno.env.get("META_TEST_EVENT_CODE");
    const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
    const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

    if (!META_PIXEL_ID || !META_ACCESS_TOKEN) {
      console.error("Meta credentials not configured");
      return new Response(
        JSON.stringify({ success: false, error: "Meta credentials not configured" }),
        { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 500 }
      );
    }

    // Parse payload
    let payload: MetaEventRequest;
    try {
      payload = await req.json();
    } catch {
      return badRequest("Invalid JSON body");
    }

    // Validate required fields
    if (!payload || typeof payload !== "object") {
      return badRequest("Missing payload");
    }
    if (!payload.eventName || typeof payload.eventName !== "string") {
      return badRequest("eventName is required");
    }
    if (!payload.eventId || typeof payload.eventId !== "string") {
      return badRequest("eventId is required");
    }
    if (
      typeof payload.eventTime !== "number" ||
      !Number.isFinite(payload.eventTime) ||
      payload.eventTime <= 0
    ) {
      return badRequest("eventTime (UNIX seconds) is required and must be > 0");
    }
    if (!payload.eventSourceUrl || typeof payload.eventSourceUrl !== "string") {
      return badRequest("eventSourceUrl is required");
    }

    // Extract client context (for requests from browser, not internal calls)
    const clientIp = payload.internalCall ? undefined :
      req.headers.get("x-forwarded-for")?.split(",")[0]?.trim() ||
      req.headers.get("x-real-ip") ||
      req.headers.get("cf-connecting-ip") ||
      undefined;
    const userAgent = payload.internalCall ? undefined :
      req.headers.get("user-agent") || undefined;

    // Build user_data
    const userData: MetaCAPIPayload["data"][0]["user_data"] = {};

    if (clientIp) userData.client_ip_address = clientIp;
    if (userAgent) userData.client_user_agent = userAgent;

    // fbp handling
    let fbp = payload.userData?.fbp || undefined;
    if (!fbp) {
      fbp = generateFbp(payload.eventTime);
    }
    userData.fbp = fbp;

    // fbc handling
    if (payload.userData?.fbc) {
      userData.fbc = payload.userData.fbc;
    }

    // Email: prefer pre-hashed, otherwise hash
    if (payload.userData?.hashedEmail) {
      userData.em = [payload.userData.hashedEmail];
    } else if (payload.userData?.email) {
      const normalizedEmail = normalizeEmail(payload.userData.email);
      if (normalizedEmail) {
        userData.em = [await sha256Hex(normalizedEmail)];
      }
    }

    // Phone: prefer pre-hashed, otherwise hash
    if (payload.userData?.hashedPhone) {
      userData.ph = [payload.userData.hashedPhone];
    } else if (payload.userData?.phone) {
      const normalizedPhone = normalizePhone(payload.userData.phone);
      if (normalizedPhone) {
        userData.ph = [await sha256Hex(normalizedPhone)];
      }
    }

    // First name
    if (payload.userData?.firstName) {
      const normFn = payload.userData.firstName.toLowerCase().trim();
      if (normFn) {
        userData.fn = [await sha256Hex(normFn)];
      }
    }

    // Last name
    if (payload.userData?.lastName) {
      const normLn = payload.userData.lastName.toLowerCase().trim();
      if (normLn) {
        userData.ln = [await sha256Hex(normLn)];
      }
    }

    // External ID (user ID)
    if (payload.userData?.externalId) {
      const ext = payload.userData.externalId.toString().trim();
      if (ext) {
        userData.external_id = [await sha256Hex(ext)];
      }
    }

    // Build CAPI payload
    const capiPayload: MetaCAPIPayload = {
      data: [
        {
          event_name: payload.eventName,
          event_time: payload.eventTime,
          event_id: payload.eventId,
          event_source_url: payload.eventSourceUrl,
          action_source: "website",
          user_data: userData,
          custom_data: payload.customData,
        },
      ],
    };

    // Add test event code if configured
    if (META_TEST_EVENT_CODE) {
      capiPayload.test_event_code = META_TEST_EVENT_CODE;
    }

    // Send to Meta Conversions API
    const metaResponse = await fetch(
      `https://graph.facebook.com/v21.0/${META_PIXEL_ID}/events?access_token=${META_ACCESS_TOKEN}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(capiPayload),
      }
    );

    const metaResult = await metaResponse.json().catch(() => ({}));

    // Log to Supabase
    if (SUPABASE_URL && SUPABASE_SERVICE_ROLE_KEY) {
      const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

      try {
        // Extract user_id from externalId if it's a valid UUID
        let userId: string | null = null;
        if (payload.userData?.externalId) {
          const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
          if (uuidRegex.test(payload.userData.externalId)) {
            userId = payload.userData.externalId;
          }
        }

        await supabase.from("meta_events").insert({
          event_name: payload.eventName,
          event_id: payload.eventId,
          user_id: userId,
          pixel_id: META_PIXEL_ID,
          event_time: new Date(payload.eventTime * 1000).toISOString(),
          event_source_url: payload.eventSourceUrl,
          user_data: {
            has_email: !!userData.em,
            has_phone: !!userData.ph,
            has_fbp: !!userData.fbp,
            has_fbc: !!userData.fbc,
            has_external_id: !!userData.external_id,
          },
          custom_data: payload.customData || {},
          capi_response: metaResult,
          processing_status: metaResponse.ok ? "success" : "failed",
        });
      } catch (dbError) {
        console.error("Error logging to database:", dbError);
        // Non-fatal - continue
      }
    }

    // Log for debugging
    console.log(`[Meta CAPI] ${payload.eventName}`, {
      eventId: payload.eventId,
      success: metaResponse.ok,
      events_received: metaResult?.events_received,
      test_mode: !!META_TEST_EVENT_CODE,
    });

    return new Response(
      JSON.stringify({
        success: metaResponse.ok,
        events_received: metaResult?.events_received,
        fbtrace_id: metaResult?.fbtrace_id,
      }),
      { 
        headers: { ...corsHeaders, "Content-Type": "application/json" }, 
        status: metaResponse.ok ? 200 : 500 
      }
    );
  } catch (error) {
    console.error("Meta CAPI error:", error);
    return new Response(
      JSON.stringify({
        success: false,
        error: error instanceof Error ? error.message : "Unknown error",
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 500 }
    );
  }
});